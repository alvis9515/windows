---
- name: Comprobar y reiniciar un servicio
  hosts: all
  tasks:

    - name: Comprobar el estado de los servicios
      win_shell: Get-Service -Name "{{ item }}" | Select-Object -ExpandProperty Status
      loop: "{{ service_names }}"
      register: services_status

    - name: Reiniciar servicios detenidos
      win_shell: Restart-Service -Name "{{ item.item }}"
      loop: "{{ services_status.results }}"
      when: item.stdout.strip() == 'Stopped'
